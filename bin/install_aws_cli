#!/usr/bin/env bash

echo "Running install aws script..."

cd /workspace

# Clean up previous installations
rm -f '/workspace/awscliv2.zip'
rm -rf '/workspace/aws'

# Download and Install AWS CLI
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install

# Confirm installation
aws sts get-caller-identity


# Create or update AWS credentials file
mkdir -p ~/.aws

{
  echo "[default]"
  echo "aws_access_key_id = $AWS_ACCESS_KEY_ID"
  echo "aws_secret_access_key = $AWS_SECRET_ACCESS_KEY"
} > ~/.aws/credentials

# Create or update AWS config file
{
  echo "[default]"
  echo "region = $AWS_DEFAULT_REGION"
  echo "output = $AWS_DEFAULT_OUTPUT"
} > ~/.aws/config

aws configure list


cd $PROJECT_ROOT

# Check AWS CLI version
aws --version

# ----------------------------------------------------------------

#!/usr/bin/env bash

set -e

KEY_NAME="lempKey"
KEY_PATH="$HOME/.ssh/${KEY_NAME}.pem"

# Function to create and store the key
create_and_store_key() {
    echo "Deleting existing key pair in AWS (if any)..."
    aws ec2 delete-key-pair --key-name "$KEY_NAME" || true

    echo "Creating new AWS EC2 key pair..."
    aws ec2 create-key-pair --key-name "$KEY_NAME" --query 'KeyMaterial' --output text > "$KEY_PATH"
    chmod 400 "$KEY_PATH"

    echo "Storing AWS private key into environment variable..."
    AWS_PRIVATE_KEY_VALUE=$(cat "$KEY_PATH")
    gp env AWS_PRIVATE_KEY="$AWS_PRIVATE_KEY_VALUE"

    echo "Storing key name in environment variable..."
    gp env AWS_KEY_NAME="$KEY_NAME"

    echo "Key created and stored successfully."
}

# Main script
echo "Setting up a fresh SSH key for AWS..."

# Always create a new key
create_and_store_key

# Ensure the key is available as id_rsa as well
cp "$KEY_PATH" "$HOME/.ssh/id_rsa"
chmod 600 "$HOME/.ssh/id_rsa"

echo "SSH key setup complete."
echo "New key pair '$KEY_NAME' has been created in AWS and stored locally."
echo "Private key location: $KEY_PATH"
echo "Usage: ssh -i $KEY_PATH ubuntu@[Public-IP]"

# Display public key for verification
echo "Public key (for verification):"
ssh-keygen -y -f "$KEY_PATH"