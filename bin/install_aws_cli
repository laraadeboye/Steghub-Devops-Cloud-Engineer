#!/usr/bin/env bash

echo "Running install aws script..."

cd /workspace

# Clean up previous installations
rm -f '/workspace/awscliv2.zip'
rm -rf '/workspace/aws'

# Download and Install AWS CLI
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install

# Confirm installation
aws sts get-caller-identity


# Create or update AWS credentials file
mkdir -p ~/.aws

{
  echo "[default]"
  echo "aws_access_key_id = $AWS_ACCESS_KEY_ID"
  echo "aws_secret_access_key = $AWS_SECRET_ACCESS_KEY"
} > ~/.aws/credentials

# Create or update AWS config file
{
  echo "[default]"
  echo "region = $AWS_DEFAULT_REGION"
  echo "output = $AWS_DEFAULT_OUTPUT"
} > ~/.aws/config

aws configure list


cd $PROJECT_ROOT

# Check AWS CLI version
aws --version

# ----------------------------------------------------------------

# set up ssh key for AWS
# Function to create and store the key
create_and_store_key() {
    echo "Creating AWS EC2 key pair..."
    aws ec2 create-key-pair --key-name lempKey --query 'KeyMaterial' --output text > ~/.ssh/lempKey.pem
    chmod 400 ~/.ssh/lempKey.pem

    echo "Storing AWS private key into environment variable..."
    AWS_PRIVATE_KEY_VALUE=$(cat ~/.ssh/lempKey.pem)
    gp env AWS_PRIVATE_KEY="$AWS_PRIVATE_KEY_VALUE"

    # Store the key name in an environment variable
    gp env AWS_KEY_NAME="lempKey"

    echo "Key created and stored successfully."
}

# Check if the AWS_KEY_NAME environment variable exists
if [ -z "$AWS_KEY_NAME" ]; then
    echo "No existing key information found."
    create_and_store_key
else
    echo "Existing key information found: $AWS_KEY_NAME"

    # Check if the key exists in AWS
    KEY_EXISTS=$(aws ec2 describe-key-pairs --key-names "$AWS_KEY_NAME" --query 'KeyPairs[0].KeyName' --output text 2>/dev/null)

    if [ "$KEY_EXISTS" == "$AWS_KEY_NAME" ]; then
        echo "AWS key pair '$AWS_KEY_NAME' exists in AWS."

        # Check if we have the private key
        if [ -n "$AWS_PRIVATE_KEY" ]; then
            echo "Using existing private key from Gitpod environment."
            echo "$AWS_PRIVATE_KEY" > ~/.ssh/lempKey.pem
            chmod 400 ~/.ssh/lempKey.pem
        else
            echo "Private key not found in Gitpod environment."
            echo "Deleting existing key pair in AWS and recreating..."
            aws ec2 delete-key-pair --key-name "$AWS_KEY_NAME"
            create_and_store_key
        fi
    else
        echo "Key pair doesn't exist in AWS. Creating new key pair..."
        create_and_store_key
    fi
fi

# Always ensure the key is available as id_rsa as well
cp ~/.ssh/lempKey.pem ~/.ssh/id_rsa
chmod 600 ~/.ssh/id_rsa

echo "SSH key setup complete."
echo "Usage: ssh -i ~/.ssh/lempKey.pem ubuntu@[Public-IP]"